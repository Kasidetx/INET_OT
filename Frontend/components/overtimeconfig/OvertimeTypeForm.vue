<template>
  <v-card class="rounded-xl pa-4">
    <v-card-title class="font-weight-bold">
      <v-icon left color="primary">mdi-plus-circle</v-icon>
      ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤‡∏á
    </v-card-title>

    <v-divider class="mb-4" />

    <v-card-text>
      <v-row>
        <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->

        <v-col cols="12">
          <label class="field-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤*</label>
          <v-text-field v-model="form.name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏≠‡∏ó‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏à-‡∏®)" outlined dense />
        </v-col>

        <v-col cols="12">
          <label class="field-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô*</label>
          <v-text-field v-model="form.employeeTypeName"
            placeholder="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ , ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥ , ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞12‡∏ä‡∏° , ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" outlined dense />
        </v-col>

        <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô -->
        <v-col cols="12" md="6">
          <label class="field-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô*</label>
          <v-text-field v-model="form.Worknametype" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô , ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î" outlined dense />
        </v-col>

        <!-- ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
        <v-col cols="12" md="6">
          <label class="field-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô*</label>
          <v-text-field v-model="form.otPeriod" placeholder="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ , ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤" outlined dense />
        </v-col>

        <!--  ‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ -->
        <v-col cols="12" md="6" v-if="form.otPeriod === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤'">
          <label class="field-label">‡∏ä‡πà‡∏ß‡∏á OT ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤*</label>
          <v-radio-group v-model="form.otContext" row>
            <v-radio label="‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô" value="AFTER_WORK" />
            <v-radio label="‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô" value="BEFORE_WORK" />
          </v-radio-group>
        </v-col>

        <!-- ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á -->
        <v-col cols="12" md="6">
          <label class="field-label">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‡∏ä‡∏°.)</label>
          <v-text-field v-model="form.min_continuousHours" outlined dense />

        </v-col>

        <!-- ‡∏´‡∏±‡∏Å‡∏û‡∏±‡∏Å -->
        <v-col cols="12" md="6">
          <label class="field-label">‡∏´‡∏±‡∏Å‡∏û‡∏±‡∏Å (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <v-text-field v-model.number="form.break_minutes" type="number" Placeholder='' outlined dense />
        </v-col>

        <!-- ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
        <v-col cols="12" md="6">
          <label class="field-label">‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ó‡πà‡∏≤)*</label>
          <v-text-field v-model.number="form.rate" type="number" min="1" max="3" step="0.5" outlined dense
            hint="‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" persistent-hint />
        </v-col>

        <!-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏é -->
        <v-col cols="12" v-if="exampleRules.length">
          <label class="field-label">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT</label>
          <v-card outlined class="pa-3">
            <div v-for="(rule, index) in exampleRules" :key="index" class="rule-item">
              <v-icon small color="success" class="mr-2">
                mdi-check-circle
              </v-icon>
              <span>{{ rule }}</span>
            </div>
          </v-card>
        </v-col>
      </v-row>
    </v-card-text>

    <v-card-actions class="pb-4 px-6">

      <!-- üî• ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
      <v-btn v-if="form.id" color="error" text @click="deleteItem">
        <v-icon left>mdi-delete</v-icon>
        ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </v-btn>

      <v-btn text @click="$emit('close')">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </v-btn>

      <v-spacer />

      <v-btn color="primary" depressed class="rounded-lg px-8" :loading="loading" @click="saveForm">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </v-btn>

    </v-card-actions>

  </v-card>
</template>

<script>
import api from '~/service/api'
import { getExampleRules } from '~/utils/overtimeconfig/otExampleRules'
import { suggestRate } from '~/utils/overtimeconfig/otRateHelper'
import { getEmployeeTypeId, getEmployeeTypeName } from '~/utils/overtimeconfig/otEmployeeHelper'
import { calculateBreak } from '~/utils/overtimeconfig/otBreakCalculator'

export default {
  name: 'OvertimeTypeForm',

  props: {
    editData: {
      type: Object,
      default: null
    }
  },

  data() {
    return {
      loading: false,
      exampleRules: [],
      form: {
        id: null,
        name: '',
        employeeTypeName: '',
        Worknametype: '',
        otPeriod: '',
        otContext: '',
        min_continuousHours: '',
        break_minutes: 0,
        rate: 1,
        start_time: null
      }
    }
  },

  watch: {
    // --------- ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ---------
    'form.employeeTypeName': 'applyRules',
    'form.Worknametype': 'applyRules',
    'form.otPeriod': 'applyRules',
    'form.otContext': 'applyAutoBreak',
    'form.min_continuousHours': 'applyAutoBreak',

    // --------- FIX BUG ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---------
    editData: {
      immediate: true,
      handler(val) {

        if (!val) {
          this.resetForm()
          return
        }


        this.form.id = val.id

        this.form.name = val.name

        this.form.employeeTypeName =
          getEmployeeTypeName(val.employee_type_id)

        this.form.Worknametype =
          val.day_type === 'WORKDAY'
            ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'
            : '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î'

        this.form.otPeriod =
          val.ot_period === 'DURING_WORK'
            ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤'
            : '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤'

        this.form.rate = val.rate
        this.form.start_time = val.start_time
        this.form.min_continuousHours = val.min_continuous_hours
        this.form.break_minutes = val.break_minutes

        this.applyRules()
        this.applyAutoBreak()
      }
    }
  },

  methods: {
    // ===============================
    // RESET FORM (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    // ===============================
    resetForm() {
      this.form = {
        id: null,
        name: '',
        employeeTypeName: '',
        Worknametype: '',
        otPeriod: '',
        otContext: '',
        min_continuousHours: '',
        break_minutes: 0,
        rate: 1,
        start_time: null
      }
      this.exampleRules = []
    },

    // ===============================
    // RULES (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ===============================
    applyRules() {
      this.exampleRules = getExampleRules(this.form)
      this.form.rate = suggestRate(this.form)

      const empTypeId =
        getEmployeeTypeId(this.form.employeeTypeName)

      const isNormalEmployee = empTypeId === 1
      const isDuringWork =
        this.form.otPeriod === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤'

      if (isNormalEmployee && isDuringWork) {
        this.form.start_time = '08:30:00'
      } else {
        this.form.start_time = null
      }

      this.applyAutoBreak()
    },

    applyAutoBreak() {
      const empTypeId =
        getEmployeeTypeId(this.form.employeeTypeName)

      const { breakMinutes } = calculateBreak({
        employeeType: empTypeId,
        workedHours: this.form.min_continuousHours,
        otPeriod: this.form.otPeriod,
        otContext: this.form.otContext
      })

      this.form.break_minutes = breakMinutes
    },

    // ===============================
    // SAVE
    // ===============================
    async saveForm() {
      if (
        !this.form.employeeTypeName ||
        !this.form.Worknametype ||
        !this.form.otPeriod
      ) {
        this.$toast?.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö')
        return
      }

      if (
        this.form.otPeriod === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤' &&
        !this.form.otContext
      ) {
        this.$toast?.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á OT ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤')
        return
      }

      const empTypeId =
        getEmployeeTypeId(this.form.employeeTypeName)

      let startCondition = null
      let startTime = null

      // ---- CORE LOGIC (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞) ----
      if (this.form.otPeriod === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤') {
        if (empTypeId === 1) {
          startCondition = 'FIXED_TIME'
          startTime = '08:30:00'
        } else {
          startCondition = null
          startTime = null
        }
      } else {
        startCondition =
          this.form.otContext === 'AFTER_WORK'
            ? 'AFTER_WORK'
            : 'BEFORE_WORK'
        startTime = null
      }

      const payload = {
        name: this.form.name,
        employee_type_id: empTypeId,
        day_type:
          this.form.Worknametype === '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'
            ? 'WORKDAY'
            : 'HOLIDAY',
        ot_period:
          this.form.otPeriod === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤'
            ? 'DURING_WORK'
            : 'OUTSIDE_WORK',
        start_time: startTime,
        start_condition: startCondition,
        rate: this.form.rate,
        min_continuous_hours:
          this.form.min_continuousHours,
        break_minutes:
          this.form.break_minutes,
        require_break:
          this.form.break_minutes > 0 ? 1 : 0,
        description:
          `${this.form.employeeTypeName} - ${this.form.Worknametype} - ${this.form.otPeriod}`,
        is_active: 1
      }

      try {
        if (this.form.id) {
          await api.put(
            `/api/otconfig/${this.form.id}`,
            payload
          )
        } else {
          await api.post('/api/otconfig', payload)
        }

        this.$toast?.success('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')
        this.$emit('saved')
        this.$emit('close')

      } catch (e) {
        console.log('SAVE ERROR =', e.response?.data)
      }
    },

    // ===============================
    // DELETE
    // ===============================
    async deleteItem() {
      const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')
      if (!ok) return

      try {
        await api.delete(`/api/otconfig/${this.form.id}`)

        this.$toast?.success('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')

        this.$emit('saved')
        this.$emit('close')

      } catch (e) {
        console.log('DELETE ERROR =', e.response?.data)
        this.$toast?.error(
          e.response?.data?.message || '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
        )
      }
    }
  }
}
</script>


<style scoped>
.field-label {
  font-size: 14px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  display: block;
}

.rule-item {
  display: flex;
  align-items: center;
  padding: 4px 0;
  font-size: 13px;
  color: #475569;
}

.rule-item:not(:last-child) {
  border-bottom: 1px dashed #e2e8f0;
  margin-bottom: 8px;
  padding-bottom: 8px;
}

.rule-item span {
  white-space: pre-line;
  display: block;
  line-height: 1.6;
}
</style>
